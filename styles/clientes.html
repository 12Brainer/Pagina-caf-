<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Clientes</title>
  <link rel="stylesheet" href="style.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
</head>
<body>
  <div id="main-nav"></div>
  <main class="container">
    <h2>Registrar cliente</h2>
    <form id="clienteForm" class="checkout">
      <div class="row">
        <div class="form-group">
          <label for="cNombre">Nombre</label>
          <input type="text" id="cNombre" required autocomplete="name" aria-describedby="clienteMsg" />
        </div>
        <div class="form-group">
          <label for="cTelefono">Teléfono</label>
          <input type="tel" id="cTelefono" required autocomplete="tel" inputmode="tel" pattern="^\\d{8,12}$" minlength="8" maxlength="12" aria-describedby="clienteMsg" />
        </div>
      </div>
      <div class="row">
        <div class="form-group">
          <label for="cCorreo">Correo</label>
          <input type="email" id="cCorreo" autocomplete="email" aria-describedby="clienteMsg" />
        </div>
        <div class="form-group">
          <label for="cProducto">Producto</label>
          <input type="text" id="cProducto" required autocomplete="off" aria-describedby="clienteMsg" />
        </div>
      </div>
      <button type="submit" class="btn btn-primary">Guardar</button>
      <div id="clienteMsg" class="form-msg" aria-live="polite" role="status"></div>
    </form>

    <h2>Clientes registrados</h2>
    <div class="table-responsive">
      <table class="table" id="clientesTabla" aria-label="Listado de clientes registrados">
        <thead>
          <tr>
            <th scope="col">ID</th>
            <th scope="col">Nombre</th>
            <th scope="col">Teléfono</th>
            <th scope="col">Correo</th>
            <th scope="col">Producto</th>
            <th scope="col">Fecha</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </main>

  <footer class="site-footer">
    <div class="footer-bottom">
      <span>© 2025 NeoPrado Coffee · Hecho en Zona de los Santos, Costa Rica</span>
    </div>
  </footer>

  <script src="scripts/main.js" defer></script>
  <script>
    (function(){
      const base = window.location.origin;

      async function cargarClientes(){
        try{
          const res = await fetch(new URL('/clientes', base), { headers: { 'Accept': 'application/json' }});
          if (!res.ok) throw new Error(`HTTP ${res.status}`);
          let data;
          try { data = await res.json(); } catch(e) { throw new Error('Respuesta no es JSON'); }

          const tbody = document.querySelector('#clientesTabla tbody');
          if (!tbody) return;
          tbody.innerHTML = '';

          if (data && data.ok && Array.isArray(data.data)){
            data.data.forEach(row => {
              const tr = document.createElement('tr');

              const tdId = document.createElement('td'); tdId.textContent = String(row.id ?? '');
              const tdNombre = document.createElement('td'); tdNombre.textContent = row.nombre ?? '';
              const tdTel = document.createElement('td'); tdTel.textContent = row.telefono ?? '';
              const tdCorreo = document.createElement('td'); tdCorreo.textContent = row.correo ?? '';
              const tdProd = document.createElement('td'); tdProd.textContent = row.producto ?? '';

              const tdFecha = document.createElement('td');
              let fechaTxt = '-';
              if (row.fecha){
                const d = new Date(row.fecha);
                if (!isNaN(d.getTime())) fechaTxt = d.toLocaleString('es-CR');
              }
              tdFecha.textContent = fechaTxt;

              tr.append(tdId, tdNombre, tdTel, tdCorreo, tdProd, tdFecha);
              tbody.appendChild(tr);
            });
          }
        }catch(err){
          console.warn('No se pudieron cargar los clientes', err);
        }
      }

      function setFieldValidity(field, valid){
        if (!field) return;
        if (valid){ field.removeAttribute('aria-invalid'); }
        else { field.setAttribute('aria-invalid', 'true'); }
      }

      document.addEventListener('DOMContentLoaded', () => {
        const form = document.getElementById('clienteForm');
        const msg = document.getElementById('clienteMsg');
        const nombreEl = document.getElementById('cNombre');
        const telEl = document.getElementById('cTelefono');
        const correoEl = document.getElementById('cCorreo');
        const prodEl = document.getElementById('cProducto');

        if (!form) return;

        form.addEventListener('submit', async (e) => {
          e.preventDefault();
          if (msg) msg.textContent = '';

          const nombre = (nombreEl?.value || '').trim();
          const telefono = (telEl?.value || '').trim();
          const correo = (correoEl?.value || '').trim();
          const producto = (prodEl?.value || '').trim();

          const telValid = /^\d{8,12}$/.test(telefono);
          const nombreValid = !!nombre;
          const prodValid = !!producto;

          setFieldValidity(nombreEl, nombreValid);
          setFieldValidity(telEl, telValid);
          setFieldValidity(prodEl, prodValid);

          if (!nombreValid || !telValid || !prodValid){
            if (msg) msg.textContent = 'Por favor, corrija los campos marcados.';
            return;
          }

          try{
            const res = await fetch(new URL('/guardarCliente', base), {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'Accept': 'application/json',
                'X-Requested-With': 'XMLHttpRequest'
              },
              body: JSON.stringify({ nombre, telefono, correo, producto })
            });

            if (!res.ok){
              let errText = '';
              try { const j = await res.json(); errText = j?.message || ''; } catch {}
              throw new Error(errText || `HTTP ${res.status}`);
            }

            const out = await res.json();
            if (out.ok){
              if (msg) msg.textContent = 'Datos guardados correctamente.';
              form.reset();
              setFieldValidity(nombreEl, true);
              setFieldValidity(telEl, true);
              setFieldValidity(prodEl, true);
              cargarClientes();
            } else {
              if (msg) msg.textContent = out.message || 'No se pudo guardar.';
            }
          }catch(err){
            if (msg) msg.textContent = 'Error de red o del servidor.';
            console.error(err);
          }
        });

        cargarClientes();
      });
    })();
  </script>
</body>
</html>